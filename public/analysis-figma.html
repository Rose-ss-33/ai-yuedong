<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå¥èº«ä¼™ä¼´ - è§†é¢‘åˆ†æ</title>
    <link rel="stylesheet" href="figma.css">
    <style>
        /* è§†é¢‘ä¸Šä¼ é¡µé¢ç‰¹å®šæ ·å¼ - ç²¾å‡†è¿˜åŸ Figma è®¾è®¡ */
        .page-title {
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
        }
        
        .back-btn {
            background: none;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 14px;
            color: #6B7280;
            cursor: pointer;
        }
        
        .main-content {
            max-width: 448px;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 80px;
        }
        
        .instruction-text {
            color: #6B7280;
            text-align: center;
            font-size: 14px;
            margin: 8px 0 16px;
        }
        
        .upload-area {
            border: 3px solid #2563EB;
            border-radius: 18px;
            height: auto;
            min-height: 240px;
            aspect-ratio: 16/9;
            max-height: 72vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2563EB;
            background: linear-gradient(180deg, #EFF6FF, #ECFDF5);
            overflow: hidden;
            margin-bottom: 16px;
        }
        
        .upload-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .upload-icon {
            font-size: 40px;
            line-height: 1;
        }
        
        .upload-text {
            color: #6B7280;
            font-size: 14px;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .upload-btn {
            flex: 1;
            border: none;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-outline {
            border: 2px solid #D1D5DB;
            background: #FFFFFF;
            color: #374151;
        }
        
        .btn-primary {
            background: #2563EB;
            color: #FFFFFF;
        }
        
        .status-text {
            margin-top: 12px;
            font-size: 12px;
            color: #6B7280;
            text-align: center;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-top: 14px;
        }
        
        .result-card {
            padding: 16px;
            border-radius: 16px;
            border: 1px solid #E5E7EB;
            background: #FFFFFF;
            text-align: center;
        }
        
        .result-label {
            color: #6B7280;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .result-value {
            font-size: 22px;
            font-weight: 700;
            color: #1F2937;
        }
        
        .tips-card {
            padding: 16px;
            border-radius: 16px;
            border: 1px solid #E5E7EB;
            background: #FFFFFF;
            margin-top: 14px;
        }
        
        .tips-title {
            color: #6B7280;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .tips-list {
            padding-left: 18px;
            margin: 0;
        }
        
        .tips-list li {
            color: #374151;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        /* åº•éƒ¨å¯¼èˆªæ ·å¼ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #FFFFFF;
            border-top: 1px solid #E5E7EB;
            padding: 8px 0;
            z-index: 100;
        }
        
        .nav-inner {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            max-width: 448px;
            margin: 0 auto;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 0;
            text-decoration: none;
            color: #6B7280;
            font-size: 12px;
            font-weight: 500;
        }
        
        .nav-item.active {
            color: #10B981;
        }
        
        .nav-icon {
            font-size: 20px;
            line-height: 1;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 480px) {
            .result-grid {
                grid-template-columns: 1fr;
            }
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
   <div class="app">
     <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
     <div class="topbar">
       <div class="topbar-inner">
         <button class="back-btn" onclick="location.href='home-figma.html'">â† è¿”å›</button>
         <div class="page-title">ä¸Šä¼ è·³ç»³è§†é¢‘</div>
         <button class="back-btn" id="resetBtn" title="é‡ç½®ç»Ÿè®¡">â™»ï¸ é‡ç½®</button>
       </div>
     </div>

     <!-- ä¸»å†…å®¹åŒºåŸŸ -->
     <div class="main-content">
       <div class="instruction-text">è¯·æ‹æ‘„30ç§’ä»¥ä¸Šè¿ç»­è·³ç»³è§†é¢‘ï¼Œå…‰çº¿å……è¶³æ›´ä½³</div>

       <!-- ä¸Šä¼ åŒºåŸŸ -->
       <div id="uploadArea" class="upload-area">
         <div id="uploadPlaceholder" class="upload-placeholder">
           <div class="upload-icon">ğŸ¥</div>
           <div class="upload-text">ç‚¹å‡»æ‹æ‘„æˆ–é€‰æ‹©å·²æœ‰è§†é¢‘</div>
         </div>
       </div>
       
       <!-- æŒ‰é’®ç»„ -->
       <div class="button-group">
         <button id="pickBtn" class="upload-btn btn-outline">ğŸ“· ä»ç›¸å†Œé€‰æ‹©</button>
         <button id="captureBtn" class="upload-btn btn-primary">ğŸ¥ æ‹æ‘„è§†é¢‘</button>
       </div>
       
       <input id="fileInput" type="file" accept="video/*" style="display:none" />

       <!-- åˆ†æçŠ¶æ€ -->
       <div id="status" class="status-text">é€‰æ‹©æˆ–æ‹æ‘„è§†é¢‘åè‡ªåŠ¨å¼€å§‹åˆ†æ</div>

       <!-- åˆ†æç»“æœ -->
       <div id="result" style="display:none;">
         <div class="result-grid">
           <div class="result-card">
             <div class="result-label">æ€»æ¬¡æ•°</div>
             <div id="count" class="result-value">-</div>
           </div>
           <div class="result-card">
             <div class="result-label">èŠ‚å¥ï¼ˆæ¬¡/åˆ†ï¼‰</div>
             <div id="cadence" class="result-value">-</div>
           </div>
           <div class="result-card">
             <div class="result-label">å¹³å‡é«˜åº¦ï¼ˆcmï¼‰</div>
             <div id="height" class="result-value">-</div>
           </div>
           <div class="result-card">
             <div class="result-label">å¯¹ç§°æ€§</div>
             <div id="symmetry" class="result-value">-</div>
           </div>
           <div class="result-card">
             <div class="result-label">å¤±è¯¯</div>
             <div id="misses" class="result-value">-</div>
           </div>
           <div class="result-card">
             <div class="result-label">åˆ†ææ—¶é•¿ï¼ˆç§’ï¼‰</div>
             <div id="duration" class="result-value">-</div>
           </div>
         </div>
         
         <div class="tips-card">
           <div class="tips-title">åŠ¨ä½œå»ºè®®</div>
           <ul id="tips" class="tips-list"></ul>
         </div>
       </div>
     </div>

     <!-- åº•éƒ¨å¯¼èˆªæ  -->
     <div class="bottom-nav">
       <div class="nav-inner">
         <a href="home-figma.html" class="nav-item">
           <span class="nav-icon"><img src="/icons/nav-home.svg" alt="" /></span>
           <span class="nav-label">é¦–é¡µ</span>
         </a>
         <a href="analysis-figma.html" class="nav-item active">
           <span class="nav-icon"><img src="/icons/nav-analysis.svg" alt="" /></span>
           <span class="nav-label">åˆ†æ</span>
         </a>
         <a href="plan-figma.html" class="nav-item">
           <span class="nav-icon"><img src="/icons/nav-plan.svg" alt="" /></span>
           <span class="nav-label">è®¡åˆ’</span>
         </a>
         <a href="data-figma.html" class="nav-item">
           <span class="nav-icon"><img src="/icons/nav-data.svg" alt="" /></span>
           <span class="nav-label">æ•°æ®</span>
         </a>
         <a href="achievements-figma.html" class="nav-item">
           <span class="nav-icon"><img src="/icons/nav-achievements.svg" alt="" /></span>
           <span class="nav-label">æˆå°±</span>
         </a>
       </div>
     </div>
   </div>

  <script>
     const fileInput = document.getElementById('fileInput')
     const pickBtn = document.getElementById('pickBtn')
     const captureBtn = document.getElementById('captureBtn')
     const statusEl = document.getElementById('status')
     const resultEl = document.getElementById('result')
     const resetBtn = document.getElementById('resetBtn')
     const uploadArea = document.getElementById('uploadArea')
     const uploadPlaceholder = document.getElementById('uploadPlaceholder')

     let currentURL = null

     // é€‰æ‹©ä¸æ‹æ‘„
     pickBtn.addEventListener('click', () => fileInput.click())
     captureBtn.addEventListener('click', () => {
       try {
         fileInput.setAttribute('capture', 'environment')
       } catch {}
       fileInput.click()
     })

     // æ‹–æ‹½ä¸Šä¼ ï¼ˆæ¡Œé¢ï¼‰
     uploadArea.addEventListener('dragover', (e) => { 
       e.preventDefault(); 
       uploadArea.style.borderColor = '#22c55e' 
     })
     uploadArea.addEventListener('dragleave', () => { 
       uploadArea.style.borderColor = '#2563EB' 
     })
     uploadArea.addEventListener('drop', (e) => {
       e.preventDefault()
       uploadArea.style.borderColor = '#2563EB'
       const f = e.dataTransfer?.files?.[0]
       if (f) handleFile(f)
     })

     fileInput.addEventListener('change', () => {
       const f = fileInput.files && fileInput.files[0]
       if (f) handleFile(f)
     })

     function handleFile(file) {
       // æ¸…ç†ä¸Šä¸€æ¬¡é¢„è§ˆ
       if (currentURL) { 
         URL.revokeObjectURL(currentURL); 
         currentURL = null 
       }
       uploadArea.style.aspectRatio = '16/9' // åˆå§‹

       // åˆ›å»º video é¢„è§ˆ
       const url = URL.createObjectURL(file)
       currentURL = url
       const video = document.createElement('video')
       video.controls = true
       video.src = url
       video.style.width = '100%'
       video.style.height = '100%'
       video.style.objectFit = 'contain'
       video.playsInline = true

       // ç­‰å…ƒæ•°æ®åŠ è½½åæŒ‰æ¯”ä¾‹è°ƒæ•´ä¸Šä¼ æ¡†
       video.onloadedmetadata = () => {
         try {
           const w = video.videoWidth || 16
           const h = video.videoHeight || 9
           if (w && h) {
             // ä½¿ç”¨ w/h å­—ç¬¦ä¸²å¯é¿å…ç²¾åº¦èˆå…¥é€ æˆçš„å¾®å°ç•™ç™½
             uploadArea.style.aspectRatio = `${w}/${h}`
             // åŠ è½½åç§»é™¤æœ€å°é«˜åº¦å¹¶æ¸…ç©ºèƒŒæ™¯ï¼Œç¡®ä¿å®Œå…¨åŒ…è£¹è§†é¢‘
             uploadArea.style.minHeight = '0'
             uploadArea.style.background = 'transparent'
           }
         } catch {}
       }

       // æ¸²æŸ“
       uploadArea.innerHTML = ''
       uploadArea.appendChild(video)
       statusEl.textContent = 'ä¸Šä¼ å¹¶åˆ†æä¸­â€¦'
       statusEl.style.color = '#6B7280'

       analyze(file)
     }

     async function analyze(file) {
       try {
         const form = new FormData()
         form.append('file', file)
         const res = await fetch('/api/analyze', { method: 'POST', body: form })
         const data = await res.json()
         if (!res.ok) {
           throw new Error((data && (data.detail || data.error)) || ('åˆ†æå¤±è´¥ï¼š' + res.status))
         }
         // æ¸²æŸ“ç»“æœ
         document.getElementById('count').textContent = data.count
         document.getElementById('cadence').textContent = data.cadence_spm
         document.getElementById('height').textContent = data.avg_height_cm
         document.getElementById('symmetry').textContent = data.symmetry_score
         document.getElementById('misses').textContent = data.misses
         document.getElementById('duration').textContent = data.duration_seconds
         const tipsEl = document.getElementById('tips')
         tipsEl.innerHTML = ''
         ;(data.analysis || []).forEach(t => {
           const li = document.createElement('li')
           li.textContent = t
           tipsEl.appendChild(li)
         })
         resultEl.style.display = ''
         statusEl.textContent = 'åˆ†æå®Œæˆ'
         statusEl.style.color = '#10B981'

         // è®°å½•åˆ°æ•°æ®é¡µï¼ˆæœ¬åœ°å­˜å‚¨ï¼Œä¸ç”¨æ ·å¼æ•°æ®ï¼‰
         const record = {
           ts: Date.now(),
           name: file && file.name,
           count: Number(data.count) || 0,
           duration: Number(data.duration_seconds) || 0,
           cadence_spm: Number(data.cadence_spm) || 0,
           // æ–°å¢ï¼šä¸ºæˆå°±ç³»ç»Ÿæä¾›è´¨é‡ä¸å¤±è¯¯æ•°æ®
           misses: Number(data.misses) || 0,
           symmetry_score: Number(data.symmetry_score) || 0,
           // ç®€å•å°†å¯¹ç§°è¯„åˆ†æ˜ å°„ä¸º 10 åˆ†åˆ¶ï¼Œä¾›"è¯„åˆ†çªç ´"æˆå°±ä½¿ç”¨ï¼ˆå¯åç»­æ›¿æ¢ä¸ºæ›´ç²¾å‡†è¯„åˆ†ï¼‰
           score10: Math.round((Number(data.symmetry_score) || 0) / 10)
         }
         const key = 'jump_records'
         const list = JSON.parse(localStorage.getItem(key) || '[]')
         list.push(record)
         localStorage.setItem(key, JSON.stringify(list))
       } catch (e) {
         statusEl.textContent = 'åˆ†æå¤±è´¥ï¼š' + String(e)
         statusEl.style.color = '#EF4444'
       }
     }

     // é‡ç½®
     resetBtn.addEventListener('click', async () => {
       try {
         statusEl.textContent = 'é‡ç½®ç»Ÿè®¡ä¸­â€¦'
         const res = await fetch('/api/reset-stats', { method: 'POST' })
         if (!res.ok) throw new Error('é‡ç½®å¤±è´¥ï¼š' + res.status)
         statusEl.textContent = 'å·²é‡ç½®ç»Ÿè®¡'
         setTimeout(() => { statusEl.textContent = 'é€‰æ‹©æˆ–æ‹æ‘„è§†é¢‘åè‡ªåŠ¨å¼€å§‹åˆ†æ' }, 1200)
         // æ¢å¤å ä½
         uploadArea.innerHTML = ''
         uploadArea.appendChild(uploadPlaceholder)
         // éšè—ç»“æœ
         resultEl.style.display = 'none'
       } catch (e) {
         statusEl.textContent = String(e)
         statusEl.style.color = '#EF4444'
       }
     })
     
     // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
     document.addEventListener('DOMContentLoaded', function() {
       const user = localStorage.getItem('user');
       if (!user) {
         window.location.href = 'login-figma.html';
       }
     });
   </script>
</body>
</html>