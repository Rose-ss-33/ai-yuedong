<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI健身伙伴 - 视频分析</title>
    <link rel="stylesheet" href="figma.css">
    <style>
        /* 视频上传页面特定样式 - 精准还原 Figma 设计 */
        .page-title {
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
        }
        
        .back-btn {
            background: none;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 14px;
            color: #6B7280;
            cursor: pointer;
        }
        
        .main-content {
            max-width: 448px;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 80px;
        }
        
        .instruction-text {
            color: #6B7280;
            text-align: center;
            font-size: 14px;
            margin: 8px 0 16px;
        }
        
        .upload-area {
            border: 3px solid #2563EB;
            border-radius: 18px;
            height: auto;
            min-height: 240px;
            aspect-ratio: 16/9;
            max-height: 72vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2563EB;
            background: linear-gradient(180deg, #EFF6FF, #ECFDF5);
            overflow: hidden;
            margin-bottom: 16px;
        }
        
        .upload-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .upload-icon {
            font-size: 40px;
            line-height: 1;
        }
        
        .upload-text {
            color: #6B7280;
            font-size: 14px;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .upload-btn {
            flex: 1;
            border: none;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-outline {
            border: 2px solid #D1D5DB;
            background: #FFFFFF;
            color: #374151;
        }
        
        .btn-primary {
            background: #2563EB;
            color: #FFFFFF;
        }
        
        .status-text {
            margin-top: 12px;
            font-size: 12px;
            color: #6B7280;
            text-align: center;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-top: 14px;
        }
        
        .result-card {
            padding: 16px;
            border-radius: 16px;
            border: 1px solid #E5E7EB;
            background: #FFFFFF;
            text-align: center;
        }
        
        .result-label {
            color: #6B7280;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .result-value {
            font-size: 22px;
            font-weight: 700;
            color: #1F2937;
        }
        
        .tips-card {
            padding: 16px;
            border-radius: 16px;
            border: 1px solid #E5E7EB;
            background: #FFFFFF;
            margin-top: 14px;
        }
        
        .tips-title {
            color: #6B7280;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .tips-list {
            padding-left: 18px;
            margin: 0;
        }
        
        .tips-list li {
            color: #374151;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        /* 底部导航样式 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #FFFFFF;
            border-top: 1px solid #E5E7EB;
            padding: 8px 0;
            z-index: 100;
        }
        
        .nav-inner {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            max-width: 448px;
            margin: 0 auto;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 0;
            text-decoration: none;
            color: #6B7280;
            font-size: 12px;
            font-weight: 500;
        }
        
        .nav-item.active {
            color: #10B981;
        }
        
        .nav-icon {
            font-size: 20px;
            line-height: 1;
        }
        
        /* 响应式调整 */
        @media (max-width: 480px) {
            .result-grid {
                grid-template-columns: 1fr;
            }
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
   <div class="app">
     <!-- 顶部导航栏 -->
     <div class="topbar">
       <div class="topbar-inner">
         <button class="back-btn" onclick="location.href='home-figma.html'">← 返回</button>
         <div class="page-title">上传跳绳视频</div>
         <button class="back-btn" id="resetBtn" title="重置统计">♻️ 重置</button>
       </div>
     </div>

     <!-- 主内容区域 -->
     <div class="main-content">
       <div class="instruction-text">请拍摄30秒以上连续跳绳视频，光线充足更佳</div>

       <!-- 上传区域 -->
       <div id="uploadArea" class="upload-area">
         <div id="uploadPlaceholder" class="upload-placeholder">
           <div class="upload-icon">🎥</div>
           <div class="upload-text">点击拍摄或选择已有视频</div>
         </div>
       </div>
       
       <!-- 按钮组 -->
       <div class="button-group">
         <button id="pickBtn" class="upload-btn btn-outline">📷 从相册选择</button>
         <button id="captureBtn" class="upload-btn btn-primary">🎥 拍摄视频</button>
       </div>
       
       <input id="fileInput" type="file" accept="video/*" style="display:none" />

       <!-- 分析状态 -->
       <div id="status" class="status-text">选择或拍摄视频后自动开始分析</div>

       <!-- 分析结果 -->
       <div id="result" style="display:none;">
         <div class="result-grid">
           <div class="result-card">
             <div class="result-label">总次数</div>
             <div id="count" class="result-value">-</div>
           </div>
           <div class="result-card">
             <div class="result-label">节奏（次/分）</div>
             <div id="cadence" class="result-value">-</div>
           </div>
           <div class="result-card">
             <div class="result-label">平均高度（cm）</div>
             <div id="height" class="result-value">-</div>
           </div>
           <div class="result-card">
             <div class="result-label">对称性</div>
             <div id="symmetry" class="result-value">-</div>
           </div>
           <div class="result-card">
             <div class="result-label">失误</div>
             <div id="misses" class="result-value">-</div>
           </div>
           <div class="result-card">
             <div class="result-label">分析时长（秒）</div>
             <div id="duration" class="result-value">-</div>
           </div>
         </div>
         
         <div class="tips-card">
           <div class="tips-title">动作建议</div>
           <ul id="tips" class="tips-list"></ul>
         </div>
       </div>
     </div>

     <!-- 底部导航栏 -->
     <div class="bottom-nav">
       <div class="nav-inner">
         <a href="home-figma.html" class="nav-item">
           <span class="nav-icon"><img src="/icons/nav-home.svg" alt="" /></span>
           <span class="nav-label">首页</span>
         </a>
         <a href="analysis-figma.html" class="nav-item active">
           <span class="nav-icon"><img src="/icons/nav-analysis.svg" alt="" /></span>
           <span class="nav-label">分析</span>
         </a>
         <a href="plan-figma.html" class="nav-item">
           <span class="nav-icon"><img src="/icons/nav-plan.svg" alt="" /></span>
           <span class="nav-label">计划</span>
         </a>
         <a href="data-figma.html" class="nav-item">
           <span class="nav-icon"><img src="/icons/nav-data.svg" alt="" /></span>
           <span class="nav-label">数据</span>
         </a>
         <a href="achievements-figma.html" class="nav-item">
           <span class="nav-icon"><img src="/icons/nav-achievements.svg" alt="" /></span>
           <span class="nav-label">成就</span>
         </a>
       </div>
     </div>
   </div>

  <script>
     const fileInput = document.getElementById('fileInput')
     const pickBtn = document.getElementById('pickBtn')
     const captureBtn = document.getElementById('captureBtn')
     const statusEl = document.getElementById('status')
     const resultEl = document.getElementById('result')
     const resetBtn = document.getElementById('resetBtn')
     const uploadArea = document.getElementById('uploadArea')
     const uploadPlaceholder = document.getElementById('uploadPlaceholder')

     let currentURL = null

     // 选择与拍摄
     pickBtn.addEventListener('click', () => fileInput.click())
     captureBtn.addEventListener('click', () => {
       try {
         fileInput.setAttribute('capture', 'environment')
       } catch {}
       fileInput.click()
     })

     // 拖拽上传（桌面）
     uploadArea.addEventListener('dragover', (e) => { 
       e.preventDefault(); 
       uploadArea.style.borderColor = '#22c55e' 
     })
     uploadArea.addEventListener('dragleave', () => { 
       uploadArea.style.borderColor = '#2563EB' 
     })
     uploadArea.addEventListener('drop', (e) => {
       e.preventDefault()
       uploadArea.style.borderColor = '#2563EB'
       const f = e.dataTransfer?.files?.[0]
       if (f) handleFile(f)
     })

     fileInput.addEventListener('change', () => {
       const f = fileInput.files && fileInput.files[0]
       if (f) handleFile(f)
     })

     function handleFile(file) {
       // 清理上一次预览
       if (currentURL) { 
         URL.revokeObjectURL(currentURL); 
         currentURL = null 
       }
       uploadArea.style.aspectRatio = '16/9' // 初始

       // 创建 video 预览
       const url = URL.createObjectURL(file)
       currentURL = url
       const video = document.createElement('video')
       video.controls = true
       video.src = url
       video.style.width = '100%'
       video.style.height = '100%'
       video.style.objectFit = 'contain'
       video.playsInline = true

       // 等元数据加载后按比例调整上传框
       video.onloadedmetadata = () => {
         try {
           const w = video.videoWidth || 16
           const h = video.videoHeight || 9
           if (w && h) {
             // 使用 w/h 字符串可避免精度舍入造成的微小留白
             uploadArea.style.aspectRatio = `${w}/${h}`
             // 加载后移除最小高度并清空背景，确保完全包裹视频
             uploadArea.style.minHeight = '0'
             uploadArea.style.background = 'transparent'
           }
         } catch {}
       }

       // 渲染
       uploadArea.innerHTML = ''
       uploadArea.appendChild(video)
       statusEl.textContent = '上传并分析中…'
       statusEl.style.color = '#6B7280'

       analyze(file)
     }

     async function analyze(file) {
       try {
         const form = new FormData()
         form.append('file', file)
         const res = await fetch('/api/analyze', { method: 'POST', body: form })
         const data = await res.json()
         if (!res.ok) {
           throw new Error((data && (data.detail || data.error)) || ('分析失败：' + res.status))
         }
         // 渲染结果
         document.getElementById('count').textContent = data.count
         document.getElementById('cadence').textContent = data.cadence_spm
         document.getElementById('height').textContent = data.avg_height_cm
         document.getElementById('symmetry').textContent = data.symmetry_score
         document.getElementById('misses').textContent = data.misses
         document.getElementById('duration').textContent = data.duration_seconds
         const tipsEl = document.getElementById('tips')
         tipsEl.innerHTML = ''
         ;(data.analysis || []).forEach(t => {
           const li = document.createElement('li')
           li.textContent = t
           tipsEl.appendChild(li)
         })
         resultEl.style.display = ''
         statusEl.textContent = '分析完成'
         statusEl.style.color = '#10B981'

         // 记录到数据页（本地存储，不用样式数据）
         const record = {
           ts: Date.now(),
           name: file && file.name,
           count: Number(data.count) || 0,
           duration: Number(data.duration_seconds) || 0,
           cadence_spm: Number(data.cadence_spm) || 0,
           // 新增：为成就系统提供质量与失误数据
           misses: Number(data.misses) || 0,
           symmetry_score: Number(data.symmetry_score) || 0,
           // 简单将对称评分映射为 10 分制，供"评分突破"成就使用（可后续替换为更精准评分）
           score10: Math.round((Number(data.symmetry_score) || 0) / 10)
         }
         const key = 'jump_records'
         const list = JSON.parse(localStorage.getItem(key) || '[]')
         list.push(record)
         localStorage.setItem(key, JSON.stringify(list))
       } catch (e) {
         statusEl.textContent = '分析失败：' + String(e)
         statusEl.style.color = '#EF4444'
       }
     }

     // 重置
     resetBtn.addEventListener('click', async () => {
       try {
         statusEl.textContent = '重置统计中…'
         const res = await fetch('/api/reset-stats', { method: 'POST' })
         if (!res.ok) throw new Error('重置失败：' + res.status)
         statusEl.textContent = '已重置统计'
         setTimeout(() => { statusEl.textContent = '选择或拍摄视频后自动开始分析' }, 1200)
         // 恢复占位
         uploadArea.innerHTML = ''
         uploadArea.appendChild(uploadPlaceholder)
         // 隐藏结果
         resultEl.style.display = 'none'
       } catch (e) {
         statusEl.textContent = String(e)
         statusEl.style.color = '#EF4444'
       }
     })
     
     // 页面加载时检查登录状态
     document.addEventListener('DOMContentLoaded', function() {
       const user = localStorage.getItem('user');
       if (!user) {
         window.location.href = 'login-figma.html';
       }
     });
   </script>
</body>
</html>