<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å†å²æ•°æ® Â· è·ƒåŠ¨åˆ†æ</title>
  <link rel="stylesheet" href="/figma.css">
  <style>
    /* å†å²æ•°æ®é¡µé¢ç‰¹å®šæ ·å¼ï¼šæ²¿ç”¨å…¨å±€ Figma é£æ ¼ï¼Œå¯¹é½ 448px ç”»æ¿ */
    .main-content { /* ä¸å†ä½¿ç”¨ï¼Œæ”¹ä¸º container.narrow */ }

    /* æ•°æ®æ¦‚è§ˆå¡ç‰‡æ ·å¼ï¼ˆç»Ÿä¸€ä¸ºå…¨ç«™ card é£æ ¼ï¼‰ */
    .data-overview {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    .data-card {
      /* ç»Ÿä¸€ Figma å¡ç‰‡é£æ ¼ */
      background: var(--white);
      border: 1px solid var(--zinc-200);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.06);
      text-align: center;
      position: relative;
    }
    .data-card-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 8px;
      font-size: 20px;
    }
    .data-card-value {
      font-size: 24px;
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: 6px;
      color: #0f172a;
    }
    .data-card-label {
      font-size: 14px;
      color: #6B7280;
      font-weight: 500;
    }

    /* è¶‹åŠ¿å›¾è¡¨åŒºåŸŸï¼ˆç»Ÿä¸€å¡ç‰‡æ ·å¼ï¼‰ */
    .trend-chart.card.padded { margin-bottom: 20px; }
    .chart-tabs {
      display: flex;
      background: #F3F4F6;
      border-radius: 10px;
      padding: 4px;
      margin-bottom: 16px;
      border: 1px solid var(--zinc-200);
    }
    .chart-tab {
      flex: 1;
      text-align: center;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      color: #475569;
    }
    .chart-tab.active {
      background: #FFFFFF;
      color: var(--primary-600);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--zinc-200);
    }
    .chart-container {
      height: 200px;
      background: linear-gradient(180deg, #F8FAFC 0%, #EEF2FF 100%);
      border-radius: 12px;
      position: relative;
      overflow: hidden;
    }

    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 480px) {
      .data-overview { grid-template-columns: 1fr; gap: 10px; }
      .data-card { padding: 14px; }
      .data-card-value { font-size: 22px; }
    }
    @media (min-width: 481px) and (max-width: 768px) {
      .data-overview { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- é¡¶éƒ¨å¯¼èˆªæ ï¼ˆä¸¥æ ¼è¿˜åŸ Figmaï¼‰ -->
    <div class="topbar">
      <div class="topbar-inner">
        <button class="icon-btn" onclick="history.length>1?history.back():location.href='/home-figma.html'" title="è¿”å›/é¦–é¡µ">â†</button>
        <div class="title">å†å²æ•°æ®</div>
        <button class="pill" id="clearBtn" title="æ¸…ç©ºè®°å½•">ğŸ—‘ æ¸…ç©º</button>
      </div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸï¼ˆä½¿ç”¨çª„å®¹å™¨ä»¥å¯¹é½ 448px ç”»æ¿ï¼‰ -->
    <main class="container narrow page">
      <!-- æ•°æ®æ¦‚è§ˆä¸‰å¡ -->
      <div class="data-overview">
        <div class="data-card card padded">
          <div class="data-card-icon" style="background: var(--blue-100); color: #1D4ED8;">ğŸ”¢</div>
          <div class="data-card-value" id="totalCount">12,580</div>
          <div class="data-card-label">æ€»è·³ç»³æ¬¡æ•°</div>
        </div>
        <div class="data-card card padded">
          <div class="data-card-icon" style="background: #FEF3C7; color: #D97706;">â±ï¸</div>
          <div class="data-card-value" id="avgScore">8.2</div>
          <div class="data-card-label">è¿‘30å¤©å¹³å‡</div>
        </div>
        <div class="data-card card padded">
          <div class="data-card-icon" style="background: var(--green-100); color: #065F46;">ğŸ“Š</div>
          <div class="data-card-value" id="completionRate">85%</div>
          <div class="data-card-label">æœ¬å‘¨è®¡åˆ’å®Œæˆåº¦</div>
        </div>
      </div>

      <!-- è¶‹åŠ¿å›¾è¡¨åŒºåŸŸ -->
      <div class="trend-chart card padded">
        <div class="chart-tabs">
          <div class="chart-tab active" data-metric="count">æ¬¡æ•°è¶‹åŠ¿</div>
          <div class="chart-tab" data-metric="score">åŠ¨ä½œè¯„åˆ†</div>
          <div class="chart-tab" data-metric="duration">è®­ç»ƒæ—¶é•¿</div>
        </div>
        <div class="chart-container" id="chartBox">
          <svg id="chart" width="100%" height="100%" viewBox="0 0 600 200" preserveAspectRatio="none"></svg>
        </div>
      </div>
    </main>

    <!-- åº•éƒ¨å¯¼èˆªï¼ˆç»Ÿä¸€æ ·å¼ï¼‰ -->
    <div class="tabbar">
      <div class="tabbar-inner" aria-label="åº•éƒ¨å¯¼èˆª">
        <a class="tab" href="/home-figma.html" aria-label="é¦–é¡µ">
          <div class="icon" aria-hidden="true"><img src="/icons/nav-home.svg" alt="" /></div>
          <span class="label">é¦–é¡µ</span>
        </a>
        <a class="tab" href="/analysis-figma.html" aria-label="åˆ†æ">
          <div class="icon" aria-hidden="true"><img src="/icons/nav-analysis.svg" alt="" /></div>
          <span class="label">åˆ†æ</span>
        </a>
        <a class="tab" href="/plan-figma.html" aria-label="è®¡åˆ’">
          <div class="icon" aria-hidden="true"><img src="/icons/nav-plan.svg" alt="" /></div>
          <span class="label">è®¡åˆ’</span>
        </a>
        <a class="tab active" href="/data-figma.html" aria-label="æ•°æ®">
          <div class="icon" aria-hidden="true"><img src="/icons/nav-data.svg" alt="" /></div>
          <span class="label">æ•°æ®</span>
        </a>
        <a class="tab" href="/achievements-figma.html" aria-label="æˆå°±" data-dot="true">
          <div class="icon" aria-hidden="true"><img src="/icons/nav-achievements.svg" alt="" /></div>
          <span class="label">æˆå°±</span>
        </a>
      </div>
    </div>
  </div>

  <script>
    const KEY = 'jump_records'
    const listEl = document.getElementById('recordList')
    const sumCountEl = document.getElementById('sumCount')
    const sumDurationEl = document.getElementById('sumDuration')
    const lastInfoEl = document.getElementById('lastInfo')
    // æ•°æ®æ¦‚è§ˆå…ƒç´ 
    const totalCountEl = document.getElementById('totalCount');
    const avgScoreEl = document.getElementById('avgScore');
    const completionRateEl = document.getElementById('completionRate');
    const clearBtn = document.getElementById('clearBtn');

    // å›¾è¡¨ç›¸å…³å…ƒç´ 
    const chartEl = document.getElementById('chart');
    const chartBox = document.getElementById('chartBox');
    let currentMetric = 'count';
    
    // å›¾è¡¨æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
    const chartTabs = document.querySelectorAll('.chart-tab');
    chartTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        chartTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentMetric = tab.dataset.metric;
        renderChart();
      });
    });

    // åˆ é™¤æ ·æœ¬æ•°æ®ï¼šæ”¹ä¸ºä½¿ç”¨åˆ†æé¡µå†™å…¥çš„ jump_records
    const getRecords = () => {
      const list = JSON.parse(localStorage.getItem(KEY) || '[]');
      return list.sort((a,b)=> (a.ts||0) - (b.ts||0));
    };
    const fmtDay = (ts) => {
      const d = new Date(ts);
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${m}/${da}`;
    };
    const getDailySeries = (metric) => {
      const recs = getRecords();
      const map = new Map(); // key: yyyy-mm-dd -> {sumCount,sumDuration,sumScore}
      for (const r of recs) {
        const d = new Date(r.ts||Date.now());
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const prev = map.get(key) || { count:0, duration:0, score:0, n:0 };
        const score = Number(r.score10 ?? (r.symmetry_score||0)/10) || 0;
        map.set(key, { count: prev.count + (Number(r.count)||0), duration: prev.duration + (Number(r.duration)||0), score: prev.score + score, n: prev.n + 1 });
      }
      const series = Array.from(map.entries()).sort((a,b)=> a[0].localeCompare(b[0])).map(([key,val])=>{
        const dayTs = new Date(key).getTime();
        const value = metric==='count' ? val.count : metric==='duration' ? val.duration : (val.n ? (val.score/val.n) : 0);
        return { date: fmtDay(dayTs), value };
      });
      return series;
    };

    // æ¸²æŸ“å›¾è¡¨ï¼ˆæ ¹æ® jump_records èšåˆæ—¥åºåˆ—ï¼‰
    function renderChart() {
      if (!chartEl) return;
      
      const W = 600, H = 200, PAD_Y = 30, PAD_X = 50;
      const baseY = H - PAD_Y;
      
      chartEl.innerHTML = '';
      
      // åˆ›å»ºæ¸å˜èƒŒæ™¯
      const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
      const grad = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
      grad.setAttribute('id', 'areaGrad');
      grad.setAttribute('x1', '0'); grad.setAttribute('y1', '0');
      grad.setAttribute('x2', '0'); grad.setAttribute('y2', '1');
      
      const s1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
      s1.setAttribute('offset', '0%'); s1.setAttribute('stop-color', '#93c5fd'); s1.setAttribute('stop-opacity', '0.35');
      const s2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
      s2.setAttribute('offset', '100%'); s2.setAttribute('stop-color', '#93c5fd'); s2.setAttribute('stop-opacity', '0.05');
      
      grad.appendChild(s1); grad.appendChild(s2);
      defs.appendChild(grad);
      chartEl.appendChild(defs);

      // ç»˜åˆ¶åæ ‡è½´
      const axisX = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      axisX.setAttribute('x1', String(PAD_X)); axisX.setAttribute('x2', String(W - PAD_X));
      axisX.setAttribute('y1', String(baseY)); axisX.setAttribute('y2', String(baseY));
      axisX.setAttribute('stroke', '#c7d2fe'); axisX.setAttribute('stroke-width', '1.5');
      chartEl.appendChild(axisX);

      const axisY = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      axisY.setAttribute('x1', String(PAD_X)); axisY.setAttribute('x2', String(PAD_X));
      axisY.setAttribute('y1', String(PAD_Y)); axisY.setAttribute('y2', String(baseY));
      axisY.setAttribute('stroke', '#c7d2fe'); axisY.setAttribute('stroke-width', '1.5');
      chartEl.appendChild(axisY);

      // ä»è®°å½•èšåˆæ•°æ®
      const series = getDailySeries(currentMetric);
      const values = series.map(s=> s.value);
      const dates = series.map(s=> s.date);
      const n = values.length;
      
      if (n === 0) {
        const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        txt.setAttribute('x', String(W / 2));
        txt.setAttribute('y', String(H / 2));
        txt.setAttribute('text-anchor', 'middle');
        txt.setAttribute('fill', '#9ca3af');
        txt.setAttribute('font-size', '12');
        txt.textContent = 'æš‚æ— æ•°æ®';
        chartEl.appendChild(txt);
        return;
      }

      // è®¡ç®—åæ ‡èŒƒå›´
      const maxValue = Math.max(...values);
      const minValue = Math.min(...values);
      const range = maxValue - minValue || 1;
      
      const X = (i) => PAD_X + (n===1? (W-2*PAD_X)/2 : i * (W - 2 * PAD_X) / (n - 1));
      const Y = (v) => baseY - ((v - minValue) / range) * (H - 2 * PAD_Y);

      // ç»˜åˆ¶ç½‘æ ¼çº¿
      const gridCount = 4;
      for (let i = 0; i <= gridCount; i++) {
        const y = PAD_Y + i * (H - 2 * PAD_Y) / gridCount;
        const grid = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        grid.setAttribute('x1', String(PAD_X));
        grid.setAttribute('x2', String(W - PAD_X));
        grid.setAttribute('y1', String(y));
        grid.setAttribute('y2', String(y));
        grid.setAttribute('stroke', '#eef2ff');
        grid.setAttribute('stroke-width', '1');
        chartEl.appendChild(grid);
      }

      // ç»˜åˆ¶æŠ˜çº¿
      let pathData = '';
      values.forEach((v, i) => {
        const x = X(i);
        const y = Y(v);
        pathData += (i === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
      });

      // ç»˜åˆ¶åŒºåŸŸå¡«å……
      if (n > 1) {
        const areaData = pathData + ` L ${X(n - 1)} ${baseY} L ${X(0)} ${baseY} Z`;
        const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        area.setAttribute('d', areaData);
        area.setAttribute('fill', 'url(#areaGrad)');
        area.setAttribute('stroke', 'none');
        chartEl.appendChild(area);
      }

      // ç»˜åˆ¶æŠ˜çº¿
      if (n > 1) {
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', pathData);
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', '#2563eb');
        path.setAttribute('stroke-width', '2');
        chartEl.appendChild(path);
      }

      // ç»˜åˆ¶æ•°æ®ç‚¹
      values.forEach((v, i) => {
        const x = X(i);
        const y = Y(v);
        
        // æ•°æ®ç‚¹
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', String(x));
        circle.setAttribute('cy', String(y));
        circle.setAttribute('r', '4');
        circle.setAttribute('fill', '#2563eb');
        circle.setAttribute('stroke', '#ffffff');
        circle.setAttribute('stroke-width', '2');
        chartEl.appendChild(circle);

        // æ—¥æœŸæ ‡ç­¾
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', String(x));
        label.setAttribute('y', String(H - 8));
        label.setAttribute('text-anchor', 'middle');
        label.setAttribute('fill', '#6b7280');
        label.setAttribute('font-size', '10');
        label.setAttribute('font-weight', '500');
        label.textContent = dates[i];
        chartEl.appendChild(label);
      });
    }

    // åˆå§‹åŒ–é¡µé¢ï¼šæ ¹æ®åˆ†æç»“æœå¡«å……æ•°æ®
    function initPage() {
      const recs = getRecords();
      const sum = (arr, f) => arr.reduce((s,x)=> s + (f(x)||0), 0);
      const avg = (arr, f) => { const vals = arr.map(f).filter(v=> Number.isFinite(v)); return vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length) : 0; };
      // æ€»æ¬¡æ•°
      const totalCount = sum(recs, r=> Number(r.count)||0);
      totalCountEl.textContent = (totalCount||0).toLocaleString();
      // å¹³å‡è¯„åˆ†ï¼ˆ10åˆ†åˆ¶ï¼‰
      const avgScore = avg(recs, r=> Number(r.score10 ?? (r.symmetry_score||0)/10) || 0);
      avgScoreEl.textContent = avgScore.toFixed(1);
      // æœ¬å‘¨è®­ç»ƒè¾¾æˆç‡ï¼ˆè¿‡å»7å¤©ï¼Œæœ‰è®°å½•çš„å¤©æ•°/7ï¼‰
      const now = new Date();
      const days = [...Array(7)].map((_,i)=> { const d = new Date(now); d.setDate(d.getDate() - i); d.setHours(0,0,0,0); return d; });
      const dayHasRecord = (d) => recs.some(r=> { const t = new Date(r.ts||Date.now()); t.setHours(0,0,0,0); return t.getTime() === d.getTime(); });
      const reached = days.filter(dayHasRecord).length;
      const completionRate = Math.round((reached/7)*100);
      completionRateEl.textContent = `${completionRate}%`;
      
      // æ¸²æŸ“å›¾è¡¨
      renderChart();
    }

    // æ¸…ç©ºè®°å½•åŠŸèƒ½ï¼ˆæ¸…é™¤æœ¬åœ°è®°å½•å¹¶å°è¯•è°ƒç”¨åç«¯é‡ç½®ï¼‰
    clearBtn.addEventListener('click', async () => {
      if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰åˆ†æè®°å½•å—ï¼Ÿ')) {
        try { localStorage.removeItem(KEY); } catch {}
        try { await fetch('/api/reset-stats', { method: 'POST' }); } catch {}
        initPage();
      }
    });

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
    document.addEventListener('DOMContentLoaded', function() {
      const user = localStorage.getItem('user');
      if (!user) {
        window.location.href = 'login-figma.html';
      } else {
        initPage();
      }
    });
  </script>
</body>
</html>