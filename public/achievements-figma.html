<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆ‘çš„æˆå°± Â· AI Fitness Buddy</title>
  <link rel="stylesheet" href="/figma.css" />
  <link rel="stylesheet" href="/achievements-figma.css" />
  <script src="/utils/achievementRules.js"></script>
</head>
<body>
  <div class="app">
    <!-- é¡¶éƒ¨æ  -->
    <div class="topbar">
      <div class="topbar-inner">
        <button class="icon-btn" id="backBtn" aria-label="è¿”å›">â†</button>
        <div class="title">æˆ‘çš„æˆå°±</div>
        <a class="pill" href="/analysis-figma.html">ğŸ¥ å»è·³ç»³åˆ†æ</a>
      </div>
    </div>

    <main class="container narrow page">
      <style>
        /* é¡µé¢çº§è¦†ç›–ï¼šæˆå°±é¡µèƒŒæ™¯æŒ‰è®¾è®¡ç¨¿ä¸ºæµ…ç°ï¼Œä¸ä½¿ç”¨å…¨ç«™ç´«è‰²/è“ç»¿æ¸å˜ */
        body { background: #F3F4F6 !important; }
        /* è¦†ç›–ä¸ºç§»åŠ¨ç«¯ Figma é£æ ¼ */
        :root { --bg: #F3F4F6; }
        .m-hero { border-radius: 20px; padding: 18px 16px; color: #fff; background: linear-gradient(135deg,#2a7df7,#8b5cf6); box-shadow: 0 10px 24px rgba(43,93,245,0.25); }
        .m-lv-label{font-size:28px;font-weight:700;text-align:center;}
        .m-lv-num{font-size:48px;font-weight:800;text-align:center; line-height:1; margin-top:2px;}
        .m-lv-title{font-size:14px;text-align:center;opacity:.95;}
        .m-bar{position:relative;margin:14px auto 4px; height:8px; border-radius:999px;}
        .m-bar-base{height:8px;background:#0b1220;border-radius:999px;}
        .m-bar-fill{position:absolute;inset:0 auto 0 0;height:8px;border-radius:999px;background:linear-gradient(90deg,#60a5fa,#8b5cf6);width:58%;}
        .m-bar-labels{display:flex;justify-content:space-between;color:#fff;font-size:12px;margin-top:6px;opacity:.95}
        .m-caption{margin-top:8px;font-size:12px;text-align:center;color:rgba(255,255,255,.92)}
        .m-stats-card{margin-top:12px;background:#fff;border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,.06);border:1px solid #e5e7eb;display:grid;grid-template-columns:1fr 1px 1fr;align-items:center}
        .m-stat{padding:14px;text-align:center}
        .m-stat-num{font-size:20px;font-weight:700;color:#0f172a}
        .m-stat-lab{font-size:12px;color:#64748b;margin-top:2px}
        .m-sep{width:100%;height:100%;background:#e5e7eb}
        .m-tabs{display:flex;gap:20px;margin:14px 0;align-items:center}
        .m-tab{border:none;background:transparent;color:#475569;font-size:14px;padding:8px 0;border-bottom:2px solid transparent;cursor:pointer}
        .m-tab.active{color:#2563eb;border-bottom-color:#2563eb}
        .m-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
        @media(min-width:560px){.m-grid{grid-template-columns:repeat(3,1fr)}}
        .tile{border-radius:16px;min-height:140px;padding:14px;position:relative;color:#fff;display:flex;flex-direction:column;gap:8px;box-shadow:0 6px 14px rgba(0,0,0,.08)}
        .tile-blue{background:linear-gradient(180deg,#2a7df7,#3b82f6)}
        .tile-sky{background:linear-gradient(180deg,#60a5fa,#3b82f6)}
        .tile-green{background:linear-gradient(180deg,#27c89e,#19a87d)}
        .tile-gray{background:linear-gradient(180deg,#e5e7eb,#cbd5e1);color:#0f172a}
        .tile-orange{background:linear-gradient(180deg,#fb923c,#f97316)}
        .tile .title{font-size:14px;font-weight:600}
        .tile .date{font-size:12px;opacity:.9}
        .tile .progressline{height:6px;border-radius:999px;background:rgba(255,255,255,.4);overflow:hidden}
        .tile .progressfill{height:100%;background:#0b1220;width:0%}
        .tile .status{position:absolute;right:12px;bottom:10px;font-size:12px;background:rgba(255,255,255,.9);color:#0f172a;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.6)}
        /* åº•éƒ¨å¯¼èˆªï¼šæ›¿æ¢ Emoji ä¸ºçŸ¢é‡å›¾æ ‡ï¼Œå¹¶æŒ‰è®¾è®¡ç¨¿æ¿€æ´»è‰² */
        .tab .icon { width:24px; height:24px; }
        .tab .icon img { width:24px; height:24px; display:block; }
        .tab .label { font-size: 12px; font-weight: 600; letter-spacing: .15px; }
        .tab.active .label { color: var(--nav-active); }
        .tab .icon svg { width:24px; height:24px; display:block; }
      </style>

      <!-- è‹±é›„å¡ï¼šä¸¥æ ¼æŒ‰ç§»åŠ¨ç«¯ Figma -->
      <section class="m-hero" aria-label="ç­‰çº§è¿›åº¦">
        <div class="m-lv-label">Lv.</div>
        <div class="m-lv-num">5</div>
        <div class="m-lv-title">è·³ç»³è¾¾äºº</div>
        <div class="m-bar">
          <div class="m-bar-base"></div>
          <div class="m-bar-fill" style="width:58%"></div>
        </div>
        <div class="m-bar-labels"><span>580/1000 ç»éªŒå€¼</span><span>58%</span></div>
        <p class="m-caption">å®Œæˆè®­ç»ƒ/æå‡åŠ¨ä½œè¯„åˆ†å¯è·ç»éªŒ</p>
      </section>

      <!-- ç»Ÿè®¡å¡ï¼šä¸¤åˆ—åˆ†éš” -->
      <div class="m-stats-card">
        <div class="m-stat">
          <div class="m-stat-num">5/15</div>
          <div class="m-stat-lab">å·²è§£é”æˆå°±</div>
        </div>
        <div class="m-sep"></div>
        <div class="m-stat">
          <div class="m-stat-num">3250</div>
          <div class="m-stat-lab">æ€»ç»éªŒå€¼</div>
        </div>
      </div>

      <!-- åˆ†ç±»ï¼šä¸‹åˆ’çº¿æ ‡ç­¾ -->
      <div class="m-tabs">
        <button class="m-tab active" data-key="all">å…¨éƒ¨</button>
        <button class="m-tab" data-key="milestone">è¿åŠ¨é‡Œç¨‹</button>
        <button class="m-tab" data-key="skill">åŠ¨ä½œçªç ´</button>
        <button class="m-tab" data-key="daily">åšæŒè®­ç»ƒ</button>
        <button class="m-tab" data-key="special">ç‰¹æ®ŠæŒ‘æˆ˜</button>
      </div>

      <!-- å½©è‰²ç£è´´ç½‘æ ¼ï¼šä¸¥æ ¼å¯¹é½ Figma è®¾è®¡ -->
      <section class="m-grid" id="mGrid">
        <article class="tile tile-blue" data-type="daily">
          <div class="title">é¦–ç§€</div>
          <div class="date" id="dateFirst">â€”</div>
          <div class="progressline"><div class="progressfill" id="pfFirst" style="width:0%"></div></div>
          <div class="status" id="stFirst">æœªè§£é”</div>
        </article>
        <article class="tile tile-sky" data-type="milestone">
          <div class="title">åƒè·³è¾¾æˆ</div>
          <div class="date" id="date1000">â€”</div>
          <div class="progressline"><div class="progressfill" id="pf1000" style="width:0%"></div></div>
          <div class="status" id="st1000">0%</div>
        </article>
        <article class="tile tile-gray" data-type="milestone">
          <div class="title">ä¸‡è·³ä¼ å¥‡</div>
          <div class="date" id="date10000">â€”</div>
          <div class="progressline"><div class="progressfill" id="pf10000" style="width:0%"></div></div>
          <div class="status" id="st10000">0%</div>
        </article>
        <article class="tile tile-gray" data-type="skill">
          <div class="title">é€Ÿåº¦ä¹‹ç‹</div>
          <div class="date" id="dateFast">â€”</div>
          <div class="progressline"><div class="progressfill" id="pfFast" style="width:0%"></div></div>
          <div class="status" id="stFast">0%</div>
        </article>
        <article class="tile tile-green" data-type="skill">
          <div class="title">å®Œç¾å§¿æ€</div>
          <div class="date" id="datePerfect">â€”</div>
          <div class="progressline"><div class="progressfill" id="pfPerfect" style="width:0%"></div></div>
          <div class="status" id="stPerfect">æœªè§£é”</div>
        </article>
        <article class="tile tile-orange" data-type="special">
          <div class="title">æ»¡åˆ†æŒ‘æˆ˜</div>
          <div class="date" id="dateFull">â€”</div>
          <div class="progressline"><div class="progressfill" id="pfFull" style="width:0%"></div></div>
          <div class="status" id="stFull">æœªè§£é”</div>
        </article>
      </section>

    </main>

    <!-- åº•éƒ¨å¯¼èˆªï¼ˆå…¨ç«™ç»Ÿä¸€ã€SVG å›¾æ ‡ï¼‰ -->
    <footer class="tabbar">
      <div class="tabbar-inner">
        <a class="tab" href="/home-figma.html" aria-label="é¦–é¡µ">
          <div class="icon" aria-hidden="true">
            <img src="/icons/nav-home.svg" alt="" />
          </div>
          <div class="label">é¦–é¡µ</div>
        </a>
        <a class="tab" href="/analysis-figma.html" aria-label="åˆ†æ">
          <div class="icon" aria-hidden="true">
            <img src="/icons/nav-analysis.svg" alt="" />
          </div>
          <div class="label">åˆ†æ</div>
        </a>
        <a class="tab" href="/plan-figma.html" aria-label="è®¡åˆ’">
          <div class="icon" aria-hidden="true">
            <img src="/icons/nav-plan.svg" alt="" />
          </div>
          <div class="label">è®¡åˆ’</div>
        </a>
        <a class="tab" href="/data-figma.html" aria-label="æ•°æ®">
          <div class="icon" aria-hidden="true">
            <img src="/icons/nav-data.svg" alt="" />
          </div>
          <div class="label">æ•°æ®</div>
        </a>
        <a class="tab active" data-dot="true" href="/achievements-figma.html" aria-label="æˆå°±">
          <div class="icon" aria-hidden="true">
            <img src="/icons/nav-achievements.svg" alt="" />
          </div>
          <div class="label">æˆå°±</div>
        </a>
      </div>
    </footer>
  </div>

  <script>
    // è¿”å›ï¼šä¼˜å…ˆå›é€€ï¼Œæ— å†å²åˆ™é¦–é¡µ
    const backBtn = document.getElementById('backBtn');
    backBtn?.addEventListener('click', () => {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        window.location.href = '/home-figma.html';
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      // ç™»å½•æ€æ ¡éªŒï¼šä¸æ•°æ®é¡µä¸€è‡´
      const user = localStorage.getItem('user');
      if (!user) { window.location.href = '/login-figma.html'; return; }

      // è¯»å–è®­ç»ƒè®°å½•
      const records = JSON.parse(localStorage.getItem('jump_records') || '[]').sort((a,b)=> (a.ts||0)-(b.ts||0));
      const sum = (arr, f) => arr.reduce((s,x)=> s + (f(x)||0), 0);
      const max = (arr, f) => arr.reduce((m,x)=> Math.max(m, f(x)||0), 0);
      const fmtDate = (ts)=> { if(!ts) return 'â€”'; const d=new Date(ts); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0'); return `${y}.${m}.${da}`; };

      // â€”â€” æ–°å¢ï¼šæ¥å…¥æˆå°±è®¡ç®—å¼•æ“ï¼Œæ›´æ–°ç­‰çº§/æ€»ç»éªŒ/è§£é”æ•° â€”â€”
      if (window.AchievementEngine) {
        const prev = JSON.parse(localStorage.getItem('achievements_state') || 'null');
        const out = window.AchievementEngine.updateAchievements(prev, records, { targetWeeklyHours: 5 });
        try { localStorage.setItem('achievements_state', JSON.stringify(out.achievements)); } catch {}

        // è‹±é›„å¡ï¼ˆç­‰çº§ä¸è¿›åº¦ï¼‰
        const lvEl = document.querySelector('.m-lv-num');
        const barFill = document.querySelector('.m-bar-fill');
        const barLabels = document.querySelector('.m-bar-labels');
        const nextNeed = out.levelInfo?.nextLevelNeed || 0;
        const into = out.levelInfo?.expIntoLevel || 0;
        const pct = nextNeed>0 ? Math.round((into/nextNeed)*100) : 0;
        if (lvEl) lvEl.textContent = String(out.level);
        if (barFill) barFill.style.width = `${pct}%`;
        if (barLabels) {
          const spans = barLabels.querySelectorAll('span');
          if (spans[0]) spans[0].textContent = `${Math.round(into)}/${Math.round(nextNeed)} ç»éªŒå€¼`;
          if (spans[1]) spans[1].textContent = `${pct}%`;
        }

        // ç»Ÿè®¡å¡ï¼šå·²è§£é”æˆå°± / æ€»ç»éªŒå€¼
        const nums = document.querySelectorAll('.m-stats-card .m-stat .m-stat-num');
        if (nums[0]) nums[0].textContent = `${out.achievements.filter(a=>a.unlocked).length}/${window.AchievementEngine.defs.length}`;
        if (nums[1]) nums[1].textContent = String(out.totalExp);

        // ç£è´´ï¼šæ˜ å°„åˆ°éƒ¨åˆ†æ ¸å¿ƒæˆå°±
        const findAch = (id) => out.achievements.find(a=> a.id===id);
        const setTile = (id, dateEl, pfEl, stEl)=> {
          const a = findAch(id); if (!a) return; const pct = Math.round(a.progress*100);
          if (pfEl) pfEl.style.width = `${pct}%`;
          if (stEl) stEl.textContent = a.unlocked ? 'å·²è§£é”' : `${pct}%`;
          if (dateEl) dateEl.textContent = a.unlockedAt ? fmtDate(a.unlockedAt) : 'â€”';
        };
        setTile('first_session', dateFirst, pfFirst, stFirst);
        setTile('total_10k', date10000, pf10000, st10000);
        setTile('score_10', dateFull, pfFull, stFull);
        // å®Œç¾å§¿æ€ï¼šä½¿ç”¨9.5åˆ†è§„åˆ™
        const ach95 = findAch('score_9_5');
        if (ach95) {
          const pctp = Math.round(ach95.progress*100);
          pfPerfect.style.width = `${pctp}%`;
          stPerfect.textContent = ach95.unlocked ? 'å·²è§£é”' : `${pctp}%`;
          datePerfect.textContent = ach95.unlockedAt ? fmtDate(ach95.unlockedAt) : 'â€”';
        }
      }

      // åŸºç¡€ç»Ÿè®¡ï¼ˆä¿ç•™ï¼šç”¨äºæœªæ¥å…¥å¼•æ“æ—¶çš„å…¼å®¹ä¸é€Ÿåº¦ä¹‹ç‹ï¼‰
      const totalCount = sum(records, r=> Number(r.count)||0);
      const bestCountSingle = max(records, r=> Number(r.count)||0);
      const bestRating = records.length? Math.max(...records.map(r=> Number(r.score10 ?? (r.symmetry_score||0)/10))) : 0;
      const bestRate = records.length? Math.max(...records.map(r=> { const c=Number(r.count)||0, d=Number(r.duration)||0; return d>0? (c/(d/60)) : 0; })) : 0;

      // é¦–ç§€ï¼ˆè‹¥æœªä½¿ç”¨å¼•æ“ï¼‰
      if (window.AchievementEngine == null && records.length) {
        dateFirst.textContent = fmtDate(records[0].ts);
        pfFirst.style.width = '100%';
        stFirst.textContent = 'å·²è§£é”';
      }

      // ç´¯è®¡é‡Œç¨‹ï¼ˆåƒè·³/ä¸‡è·³ï¼‰
      let acc = 0, ts1000 = null, ts10000 = null;
      for(const r of records){ acc += Number(r.count)||0; if(!ts1000 && acc>=1000) ts1000 = r.ts; if(!ts10000 && acc>=10000) ts10000 = r.ts; }
      const pct1000 = Math.min(100, Math.round((totalCount/1000)*100));
      pf1000.style.width = `${pct1000}%`;
      st1000.textContent = ts1000? 'å·²è§£é”' : `${pct1000}%`;
      date1000.textContent = fmtDate(ts1000);

      const pct10000 = Math.min(100, Math.round((totalCount/10000)*100));
      pf10000.style.width = `${pct10000}%`;
      st10000.textContent = ts10000? 'å·²è§£é”' : `${pct10000}%`;
      date10000.textContent = fmtDate(ts10000);

      // é€Ÿåº¦ä¹‹ç‹ï¼ˆâ‰¥ 240 æ¬¡/åˆ†é’Ÿï¼‰
      const speedTarget = 240;
      const pctFast = Math.min(100, Math.round((bestRate/speedTarget)*100));
      pfFast.style.width = `${pctFast}%`;
      stFast.textContent = bestRate>=speedTarget? 'å·²è§£é”' : `${pctFast}%`;
      dateFast.textContent = fmtDate(records.find(r=>{ const c=Number(r.count)||0, d=Number(r.duration)||0; return d>0 && (c/(d/60))>=speedTarget; })?.ts);

      // å®Œç¾å§¿æ€ï¼ˆè¯„åˆ† â‰¥ 9.5ï¼Œä¸å¼•æ“ä¸€è‡´ï¼‰
      const pctPerfect = Math.min(100, Math.round((bestRating/9.5)*100));
      pfPerfect.style.width = `${pctPerfect}%`;
      if (window.AchievementEngine == null) {
        stPerfect.textContent = bestRating>=9.5? 'å·²è§£é”' : `${pctPerfect}%`;
        datePerfect.textContent = fmtDate(records.find(r=>{ const s=Number(r.score10 ?? (r.symmetry_score||0)/10); return s>=9.5; })?.ts);
      }

      // æ»¡åˆ†æŒ‘æˆ˜ï¼ˆè¯„åˆ† = 10ï¼‰å…¼å®¹ä¿ç•™ï¼ˆå¼•æ“å·²è¦†ç›–ï¼‰
      const pctFull = Math.min(100, Math.round((bestRating/10)*100));
      pfFull.style.width = `${pctFull}%`;
      if (window.AchievementEngine == null) {
        stFull.textContent = bestRating>=10? 'å·²è§£é”' : 'æœªè§£é”';
        dateFull.textContent = fmtDate(records.find(r=>{ const s=Number(r.score10 ?? (r.symmetry_score||0)/10); return s>=10; })?.ts);
      }

      // åˆ†ç±»ç­›é€‰
      const tabs = document.querySelectorAll('.m-tab');
      const cards = document.querySelectorAll('#mGrid .tile');
      tabs.forEach(btn=>{
        btn.addEventListener('click',()=>{
          tabs.forEach(b=> b.classList.toggle('active', b===btn));
          const key = btn.dataset.key;
          cards.forEach(card=>{ card.style.display = (key==='all' || card.dataset.type===key)? 'flex' : 'none'; });
        })
      })
    });
  </script>
</body>
</html>